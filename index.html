<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Lager App</title>
<style>
body {margin:0; background:#000; color:white; font-family:Arial, sans-serif; overflow:hidden;}
#topbar {position:fixed; top:0; left:0; right:0; padding:15px; background:#000; z-index:9999; border-bottom:2px solid #333;}
#counterWrapper {display:grid; grid-template-columns:repeat(2,1fr); gap:8px;}
.counter-box {padding:10px; border:1px solid #444; border-radius:10px; background:#000; box-shadow:0 4px 10px rgba(0,0,0,0.45);}
.counter-title {font-size:11px;color:#bbb;}
.counter-value {font-size:18px;font-weight:bold;}
#searchRow {margin-top:10px; display:flex; justify-content:center;}
#search {width:95%; padding:10px; border-radius:8px; background:#111; border:1px solid #444; color:white; box-sizing:border-box;}
#buttonRow {margin-top:10px; display:flex; gap:8px; touch-action:manipulation;}
#buttonRow button {flex:1; padding:10px; font-size:11px; color:#bbb; border-radius:10px; background:#000; border:1px solid #444; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.45);}
#buttonRow button:active {background:#111;}
#tableContainer {position:absolute; left:0; right:0; bottom:0; top:185px; overflow:auto; -webkit-overflow-scrolling:touch;}
table {width:100%; border-collapse:collapse; font-size:12px; table-layout:auto;}
th {background:#111; position:sticky; top:0; z-index:5; padding:5px; color:#bbb; font-weight:bold;}
td {padding:5px; border-bottom:1px solid #222; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;}
#popup {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#111; padding:10px; border:2px solid #444; border-radius:12px; width:80%; max-width:320px; display:none; z-index:10000;}
.popup-row {margin-bottom:6px; display:flex; flex-direction:column;}
.popup-row label {font-size:13px; margin-bottom:2px;}
.popup-row input, .popup-row textarea {width:95%; margin:0 auto; padding:6px; border-radius:6px; border:1px solid #444; background:#1a1a1a; color:white; font-size:13px; box-sizing:border-box;}
#popup button {padding:8px; border-radius:8px; background:#000; border:1px solid #444; color:white; font-weight:bold; font-size:13px;}
.icon-btn {cursor:pointer; margin-left:4px; font-size:14px;}
input.table-input {width:50px; background:#111; color:white; border:1px solid #444; border-radius:4px; text-align:center;}
</style>
</head>
<body>

<div id="topbar">
    <div id="counterWrapper">
        <div class="counter-box"><div class="counter-title">Artikel im Bestand</div><div class="counter-value" id="countArtikel">0</div></div>
        <div class="counter-box"><div class="counter-title">Gegenstände insgesamt</div><div class="counter-value" id="countMenge">0</div></div>
        <div class="counter-box"><div class="counter-title">Warenwert aktuell (€)</div><div class="counter-value" id="countWert">0</div></div>
        <div class="counter-box"><div class="counter-title">Warenwert gesamt (€)</div><div class="counter-value" id="countWertTotal">0</div></div>
    </div>
    <div id="searchRow">
        <input type="text" id="search" placeholder="Suchen …" oninput="searchTable()">
    </div>
    <div id="buttonRow">
        <button onclick="openPopup()">Artikel anlegen</button>
        <button onclick="exportData()">Sicherung speichern</button>
        <button onclick="importData()">Sicherung laden</button>
        <button onclick="generatePDF()">Inventur PDF</button>
    </div>
</div>

<div id="tableContainer">
<table id="artikelTable">
<thead>
<tr>
<th>ArtNr</th><th>Name</th><th>Menge</th><th>Größe</th><th>Preis</th><th>Ort</th><th>Gekauft</th><th>Aktionen</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<div id="popup">
<div class="popup-row"><label>Artikelnummer</label><input id="p_artnr"></div>
<div class="popup-row"><label>Name</label><input id="p_name"></div>
<div class="popup-row"><label>Menge</label><input type="number" id="p_menge" min="1" value="1"></div>
<div class="popup-row"><label>Größe</label><input id="p_groesse" placeholder="z. B. S, M, L, XL"></div>
<div class="popup-row"><label>Preis</label><input type="number" id="p_preis" step="0.01"></div>
<div class="popup-row"><label>Wo gekauft</label><input id="p_ort"></div>
<div class="popup-row"><label>Wann gekauft</label><input type="date" id="p_datum" style="width:95%; text-align:center;"></div>
<div class="popup-row"><label>Bild / Rechnung</label><input type="file" id="p_bild" accept="image/*"></div>
<div class="popup-row"><label>Notiz</label><textarea id="p_notiz" rows="2"></textarea></div>
<div style="display:flex; gap:10px;">
<button onclick="saveArtikel()" style="flex:1;">Speichern</button>
<button onclick="document.getElementById('popup').style.display='none'; editIndex=null;" style="flex:1;">Abbrechen</button>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// Daten
let artikel = JSON.parse(localStorage.getItem("lagerData") || "[]");
let editIndex = null;

// 30 Testartikel
if(artikel.length === 0){
    const names = ["Plüschtier","Puzzle","Bausteine","Actionfigur","Brettspiel","Lernspiel","Fahrradhelm","Sandkastenform","Knete-Set","Malkasten"];
    const groessen = ["S","M","L","XL"];
    const orte = ["Spielzeugladen","Online-Shop","Supermarkt","Marktstand"];
    const heute = new Date();
    for(let i=1;i<=30;i++){
        const artnr = String(i).padStart(3,'0') + "-" + heute.getFullYear();
        const name = names[Math.floor(Math.random()*names.length)] + " " + (Math.floor(Math.random()*100)+1);
        const menge = Math.floor(Math.random()*5)+1;
        const groesse = groessen[Math.floor(Math.random()*groessen.length)];
        const preis = (Math.random()*45 +5).toFixed(2);
        const ort = orte[Math.floor(Math.random()*orte.length)];
        const datum = new Date(heute.getFullYear(), Math.floor(Math.random()*12), Math.floor(Math.random()*28)+1);
        const tag = ("0"+datum.getDate()).slice(-2);
        const monat = ("0"+(datum.getMonth()+1)).slice(-2);
        const jahr = datum.getFullYear();
        artikel.push({artnr,name,menge,groesse,preis:Number(preis),ort,datum:`${jahr}-${monat}-${tag}`,bild:"",notiz:"Testnotiz"});
    }
    localStorage.setItem("lagerData", JSON.stringify(artikel));
}

// Funktionen wie in Teil 2 & 3

function getNextArtNr() {
    const currentYear = new Date().getFullYear();
    const existing = artikel.filter(a => a.artnr.endsWith(currentYear));
    let nextNum = 1;
    if(existing.length>0){
        const nums = existing.map(a => parseInt(a.artnr.split("-")[0],10));
        nextNum = Math.max(...nums)+1;
    }
    return String(nextNum).padStart(3,'0') + "-" + currentYear;
}

function openPopup(){
    document.getElementById("popup").style.display="block";
    if(editIndex === null){
        document.getElementById("p_artnr").value = getNextArtNr();
        document.getElementById("p_name").value = "";
        document.getElementById("p_menge").value = 1;
        document.getElementById("p_groesse").value = "";
        document.getElementById("p_preis").value = "";
        document.getElementById("p_ort").value = "";
        document.getElementById("p_datum").value = "";
        document.getElementById("p_notiz").value = "";
        document.getElementById("p_bild").value = "";
    }
}

function formatDatum(d){
    if(!d) return "";
    const dt=new Date(d);
    const tag=("0"+dt.getDate()).slice(-2);
    const monat=("0"+(dt.getMonth()+1)).slice(-2);
    const jahr=dt.getFullYear();
    return `${tag}-${monat}-${jahr}`;
}

// Alle weiteren Funktionen: saveArtikel, renderTable, updateCounters, searchTable, showNote, showImage, toggleMark, deleteItem, openEdit, exportData, importData, generatePDF
// ... (wie vorherige Teile, unverändert)

updateCounters();
renderTable();
</script>
</body>
</html>
