<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no">
<title>Lager App</title>

<style>
body{margin:0;background:#000;color:white;font-family:Arial,sans-serif;overflow:hidden;}
#topbar{position:fixed;top:0;left:0;right:0;padding:15px;background:#000;z-index:5000;border-bottom:2px solid #333;}
#counterWrapper{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
.counter-box{padding:10px;border:1px solid #444;border-radius:10px;background:#000;}
.counter-title{font-size:11px;color:#bbb;}
.counter-value{font-size:18px;font-weight:bold;}
#searchRow{margin-top:10px;}
#search{width:100%;padding:10px;border-radius:8px;background:#111;border:1px solid #444;color:white;box-sizing:border-box;}
#buttonRow{margin-top:10px;display:flex;gap:8px;}
#buttonRow button{flex:1;padding:10px;font-size:11px;color:#bbb;border-radius:10px;background:#000;border:1px solid #444;font-weight:bold;}

#tableContainer{
  position:fixed;left:0;right:0;bottom:0;
  overflow-y:auto;overflow-x:auto;
  background:#000;z-index:100;
}

table{width:100%;border-collapse:collapse;}
th{background:#111;position:sticky;top:0;z-index:200;padding:6px;color:#bbb;font-size:10px;white-space:nowrap;}
td{padding:5px;font-size:11px;border-bottom:1px solid #222;white-space:nowrap;}
.iconCell span{cursor:pointer;margin-right:10px;}
.iconCell span.delete{margin-left:20px;}

#popup,#viewPopup{
position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
background:#111;padding:16px;border:2px solid #444;border-radius:12px;
width:90%;max-width:360px;max-height:90vh;overflow-y:auto;display:none;z-index:9999;
}
.popup-row{margin-bottom:8px;}
.popup-row label{font-size:12px;color:#bbb;display:block;margin-bottom:3px;}
.popup-row input,.popup-row textarea{
width:100%;padding:8px;border-radius:8px;
border:1px solid #444;background:#1a1a1a;color:white;
}
#popupButtons{display:flex;gap:8px;margin-top:10px;}
#popupButtons button{
flex:1;padding:11px;border-radius:10px;
background:#000;border:1px solid #444;color:white;font-weight:bold;
}
img.preview{max-width:100%;border-radius:8px;margin-top:10px;}
</style>
</head>

<body>

<div id="topbar">
  <div id="counterWrapper">
    <div class="counter-box"><div class="counter-title">Artikel im Bestand</div><div id="countArtikel">0</div></div>
    <div class="counter-box"><div class="counter-title">GegenstÃ¤nde insgesamt</div><div id="countMenge">0</div></div>
    <div class="counter-box"><div class="counter-title">Warenwert aktuell (â‚¬)</div><div id="countWert">0</div></div>
    <div class="counter-box"><div class="counter-title">Warenwert gesamt (â‚¬)</div><div id="countWertTotal">0</div></div>
  </div>

  <div id="searchRow"><input id="search" placeholder="Suchen â€¦"></div>

  <div id="buttonRow">
    <button id="btnAdd">Artikel anlegen</button>
    <button id="btnExport">Sichern</button>
    <button id="btnImport">Laden</button>
    <button id="btnPDF">PDF</button>
  </div>
</div>

<div id="tableContainer">
<table>
<thead>
<tr>
<th>Nr</th><th>Name</th><th>Menge</th>
<th>GrÃ¶ÃŸe</th><th>Preis</th><th>Ort</th>
<th>Datum</th><th>Aktionen</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<div id="popup">
  <div class="popup-row"><label>Artikelnummer</label><input id="p_artnr"></div>
  <div class="popup-row"><label>Name</label><input id="p_name"></div>
  <div class="popup-row"><label>Menge</label><input type="number" id="p_menge" value="1"></div>
  <div class="popup-row"><label>GrÃ¶ÃŸe</label><input id="p_groesse"></div>
  <div class="popup-row"><label>Preis</label><input type="number" id="p_preis"></div>
  <div class="popup-row"><label>Ort</label><input id="p_ort"></div>
  <div class="popup-row"><label>Datum</label><input type="date" id="p_datum"></div>
  <div class="popup-row"><label>Bild</label><input type="file" id="p_bild" accept="image/*"></div>

  <div id="popupButtons">
    <button id="btnSave">Speichern</button>
    <button id="btnCancel">Abbrechen</button>
  </div>
</div>

<div id="viewPopup"></div>

<script>
/* =========================
   INDEXEDDB FÃœR BILDER
========================= */
let db;
const request = indexedDB.open("lagerImages",1);
request.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("images",{keyPath:"id"});
};
request.onsuccess = e => db = e.target.result;

/* =========================
   ARTIKEL-DATEN (LEERER START)
========================= */
let artikel = JSON.parse(localStorage.getItem("lagerData") || "[]");

/* =========================
   TABLE + COUNTER
========================= */
function renderTable(){
  tableBody.innerHTML="";
  let menge=0, wert=0;

  artikel.forEach(a=>{
    menge+=a.menge;
    wert+=a.menge*a.preis;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${a.artnr}</td>
      <td>${a.name}</td>
      <td>${a.menge}</td>
      <td>${a.groesse}</td>
      <td>${a.preis.toFixed(2)}</td>
      <td>${a.ort}</td>
      <td>${a.datum}</td>
      <td class="iconCell">
        <span onclick="viewImg('${a.artnr}')">ðŸ“·</span>
        <span class="delete" onclick="del('${a.artnr}')">ðŸ—‘</span>
      </td>`;
    tableBody.appendChild(tr);
  });

  countArtikel.textContent=artikel.length;
  countMenge.textContent=menge;
  countWert.textContent=wert.toFixed(2);
  countWertTotal.textContent=wert.toFixed(2);
  adjustTableTop();
}

/* =========================
   TABELLE POSITIONIEREN
========================= */
function adjustTableTop(){
  tableContainer.style.top=
  topbar.offsetHeight+"px";
}
window.onload=adjustTableTop;
window.onresize=adjustTableTop;

/* =========================
   POPUP
========================= */
btnAdd.onclick=()=>{
  p_artnr.value="";
  p_name.value="";
  p_menge.value=1;
  p_groesse.value="";
  p_preis.value="";
  p_ort.value="";
  p_datum.value="";
  p_bild.value="";
  popup.style.display="block";
};

btnCancel.onclick=()=>popup.style.display="none";

/* =========================
   SPEICHERN (MIT INDEXEDDB)
========================= */
btnSave.onclick=()=>{
  const obj={
    artnr:p_artnr.value.trim(),
    name:p_name.value.trim(),
    menge:+p_menge.value,
    groesse:p_groesse.value,
    preis:+p_preis.value,
    ort:p_ort.value,
    datum:p_datum.value
  };

  artikel.push(obj);
  localStorage.setItem("lagerData",JSON.stringify(artikel));

  const file=p_bild.files[0];
  if(file){
    const r=new FileReader();
    r.onload=e=>{
      const tx=db.transaction("images","readwrite");
      const store=tx.objectStore("images");
      store.put({id:obj.artnr,img:e.target.result});
    };
    r.readAsDataURL(file);
  }

  popup.style.display="none";
  renderTable();
};

/* =========================
   BILD ANZEIGEN
========================= */
function viewImg(id){
  const tx=db.transaction("images","readonly");
  const store=tx.objectStore("images");
  const r=store.get(id);
  r.onsuccess=()=>{
    viewPopup.innerHTML=r.result?
    `<img class="preview" src="${r.result.img}">
    <br><button onclick="viewPopup.style.display='none'">SchlieÃŸen</button>`:
    `Kein Bild vorhanden<br><button onclick="viewPopup.style.display='none'">SchlieÃŸen</button>`;
    viewPopup.style.display="block";
  };
}

/* =========================
   LÃ–SCHEN
========================= */
function del(id){
  if(!confirm("Wirklich lÃ¶schen?"))return;

  artikel=artikel.filter(a=>a.artnr!==id);
  localStorage.setItem("lagerData",JSON.stringify(artikel));

  const tx=db.transaction("images","readwrite");
  tx.objectStore("images").delete(id);

  renderTable();
}

/* =========================
   SICHERN / LADEN
========================= */
btnExport.onclick=()=>{
  const blob=new Blob([JSON.stringify(artikel)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="lager.json";
  a.click();
};

btnImport.onclick=()=>{
  const inp=document.createElement("input");
  inp.type="file";
  inp.accept="application/json";
  inp.onchange=e=>{
    const r=new FileReader();
    r.onload=()=>{
      artikel=JSON.parse(r.result);
      localStorage.setItem("lagerData",JSON.stringify(artikel));
      renderTable();
    };
    r.readAsText(e.target.files[0]);
  };
  inp.click();
};

/* =========================
   PDF
========================= */
btnPDF.onclick=()=>{
  let w=window.open("","_blank");
  let html="<table border='1'><tr><th>Nr</th><th>Name</th><th>Menge</th></tr>";
  artikel.forEach(a=>{
    html+=`<tr><td>${a.artnr}</td><td>${a.name}</td><td>${a.menge}</td></tr>`;
  });
  html+="</table>";
  w.document.write(html);
  w.print();
};

/* =========================
   SUCHE
========================= */
search.oninput=()=>{
  const q=search.value.toLowerCase();
  document.querySelectorAll("#tableBody tr").forEach(r=>{
    r.style.display=r.innerText.toLowerCase().includes(q)?"":"none";
  });
};

renderTable();
</script>

</body>
</html>
