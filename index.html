<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no">
<title>Lager App</title>

<style>
body{margin:0;background:#000;color:white;font-family:Arial,sans-serif;overflow:hidden;}

#topbar{position:fixed;top:0;left:0;right:0;padding:15px;background:#000;z-index:1000;border-bottom:2px solid #333;}

#counterWrapper{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
.counter-box{padding:10px;border:1px solid #444;border-radius:10px;background:#000;}
.counter-title{font-size:11px;color:#bbb;}
.counter-value{font-size:18px;font-weight:bold;}

#searchRow{margin-top:10px;}
#search{width:100%;padding:10px;border-radius:8px;background:#111;border:1px solid #444;color:white;box-sizing:border-box;}

#buttonRow{margin-top:10px;display:flex;gap:8px;}
#buttonRow button{flex:1;padding:10px;font-size:11px;color:#bbb;border-radius:10px;background:#000;border:1px solid #444;font-weight:bold;}

#tableContainer{position:fixed;left:0;right:0;bottom:0;overflow-y:auto;overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;}
th{background:#111;position:sticky;top:0;padding:6px;color:#bbb;font-size:10px;white-space:nowrap;}
td{padding:5px;font-size:11px;border-bottom:1px solid #222;white-space:nowrap;}
.marked{background:#222;}

.iconCell span{cursor:pointer;margin-right:8px;}
.iconCell span.delete{margin-left:18px;}

#popup,#viewPopup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;padding:18px;border:2px solid #444;border-radius:12px;width:90%;max-width:380px;max-height:85vh;overflow-y:auto;display:none;z-index:9999;}

.popup-row{margin-bottom:10px;}
.popup-row label{font-size:12px;color:#bbb;display:block;margin-bottom:3px;}
.popup-row input,.popup-row textarea{width:100%;padding:9px;border-radius:8px;border:1px solid #444;background:#1a1a1a;color:white;box-sizing:border-box;}

#popupButtons{display:flex;gap:8px;margin-top:10px;}
#popupButtons button{flex:1;padding:12px;border-radius:10px;background:#000;border:1px solid #444;color:white;font-weight:bold;}

img.preview{max-width:100%;border-radius:8px;margin-top:10px;}
</style>
</head>

<body>

<div id="topbar">
  <div id="counterWrapper">
    <div class="counter-box"><div class="counter-title">Artikel im Bestand</div><div class="counter-value" id="countArtikel">0</div></div>
    <div class="counter-box"><div class="counter-title">Gegenst√§nde insgesamt</div><div class="counter-value" id="countMenge">0</div></div>
    <div class="counter-box"><div class="counter-title">Warenwert aktuell (‚Ç¨)</div><div class="counter-value" id="countWert">0</div></div>
    <div class="counter-box"><div class="counter-title">Warenwert gesamt (‚Ç¨)</div><div class="counter-value" id="countWertTotal">0</div></div>
  </div>

  <div id="searchRow">
    <input id="search" placeholder="Suchen ‚Ä¶">
  </div>

  <div id="buttonRow">
    <button id="btnAdd">Artikel anlegen</button>
    <button id="btnExport">Sichern</button>
    <button id="btnImport">Laden</button>
    <button id="btnPDF">PDF</button>
  </div>
</div>

<div id="tableContainer">
  <table>
    <thead>
      <tr>
        <th>*</th>
        <th>Nr</th>
        <th>Name</th>
        <th>Menge</th>
        <th>Gr√∂√üe</th>
        <th>Preis</th>
        <th>Ort</th>
        <th>Datum</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- ARTIKEL-POPUP -->
<div id="popup">
  <div class="popup-row"><label>Artikelnummer</label><input id="p_artnr"></div>
  <div class="popup-row"><label>Name</label><input id="p_name"></div>
  <div class="popup-row"><label>Menge</label><input type="number" id="p_menge" value="1" min="0"></div>
  <div class="popup-row"><label>Gr√∂√üe</label><input id="p_groesse"></div>
  <div class="popup-row"><label>Preis</label><input type="number" id="p_preis" step="0.01" min="0"></div>
  <div class="popup-row"><label>Ort</label><input id="p_ort"></div>
  <div class="popup-row"><label>Datum</label><input type="date" id="p_datum"></div>
  <div class="popup-row"><label>Bild / Rechnung</label><input type="file" id="p_bild" accept="image/*"></div>
  <div class="popup-row"><label>Notiz</label><textarea id="p_notiz"></textarea></div>

  <div id="popupButtons">
    <button id="btnSave">Speichern</button>
    <button id="btnCancel">Abbrechen</button>
  </div>
</div>

<!-- VIEW-POPUP (Bild/Notiz) -->
<div id="viewPopup"></div>

<script>
(function(){
  // ---- DOM-REFS ----
  const topbar = document.getElementById('topbar');
  const tableContainer = document.getElementById('tableContainer');
  const tableBody = document.getElementById('tableBody');

  const countArtikel = document.getElementById('countArtikel');
  const countMenge = document.getElementById('countMenge');
  const countWert = document.getElementById('countWert');
  const countWertTotal = document.getElementById('countWertTotal');

  const searchInput = document.getElementById('search');

  const popup = document.getElementById('popup');
  const viewPopup = document.getElementById('viewPopup');

  const p_artnr = document.getElementById('p_artnr');
  const p_name = document.getElementById('p_name');
  const p_menge = document.getElementById('p_menge');
  const p_groesse = document.getElementById('p_groesse');
  const p_preis = document.getElementById('p_preis');
  const p_ort = document.getElementById('p_ort');
  const p_datum = document.getElementById('p_datum');
  const p_bild = document.getElementById('p_bild');
  const p_notiz = document.getElementById('p_notiz');

  const btnAdd = document.getElementById('btnAdd');
  const btnExport = document.getElementById('btnExport');
  const btnImport = document.getElementById('btnImport');
  const btnPDF = document.getElementById('btnPDF');
  const btnSave = document.getElementById('btnSave');
  const btnCancel = document.getElementById('btnCancel');

  // ---- DATEN ----
  let artikel = [];
  try {
    artikel = JSON.parse(localStorage.getItem('lagerData') || '[]') || [];
  } catch(e) {
    artikel = [];
  }
  let editIndex = -1;

  // Testdaten, falls leer
  if (artikel.length === 0) {
    artikel = [
      {artnr:"1001",name:"Winterjacke",menge:2,groesse:"L",preis:59.99,ort:"Zara",datum:"2023-11-12",bild:"",notiz:"gef√ºttert",markiert:false},
      {artnr:"1002",name:"Sneaker Black",menge:1,groesse:"43",preis:89.90,ort:"Snipes",datum:"2024-02-01",bild:"",notiz:"",markiert:false},
      {artnr:"1003",name:"Jeans Blau",menge:3,groesse:"32/32",preis:39.95,ort:"H&M",datum:"2023-10-20",bild:"",notiz:"Stretch",markiert:false},
      {artnr:"1004",name:"Hoodie Grau",menge:1,groesse:"XL",preis:29.99,ort:"H&M",datum:"2024-01-15",bild:"",notiz:"",markiert:false},
      {artnr:"1005",name:"Kappe Schwarz",menge:5,groesse:"One Size",preis:14.99,ort:"Footlocker",datum:"2024-03-02",bild:"",notiz:"neu",markiert:false},
      {artnr:"1006",name:"Socken 10er Pack",menge:10,groesse:"42-44",preis:12.99,ort:"Primark",datum:"2024-04-10",bild:"",notiz:"Baumwolle",markiert:false},
      {artnr:"1007",name:"Handschuhe",menge:2,groesse:"L",preis:19.99,ort:"Decathlon",datum:"2023-12-03",bild:"",notiz:"Winter",markiert:false},
      {artnr:"1008",name:"Rucksack",menge:1,groesse:"30L",preis:49.99,ort:"Amazon",datum:"2024-02-18",bild:"",notiz:"Laptopfach",markiert:false},
      {artnr:"1009",name:"T-Shirt Wei√ü",menge:6,groesse:"L",preis:9.99,ort:"H&M",datum:"2024-01-10",bild:"",notiz:"Basic",markiert:false},
      {artnr:"1010",name:"Sporthose",menge:2,groesse:"M",preis:24.99,ort:"Adidas",datum:"2024-03-20",bild:"",notiz:"atmungsaktiv",markiert:false}
    ];
    persist();
  }

  // ---- HELFER ----
  function persist(){
    localStorage.setItem('lagerData', JSON.stringify(artikel));
  }

  function formatDatum(d){
    if (!d) return "";
    const parts = d.split("-");
    if (parts.length !== 3) return d;
    const [y,m,day] = parts;
    return `${day}-${m}-${y}`;
  }

  function adjustTableTop(){
    const h = topbar.offsetHeight;
    tableContainer.style.top = h + 'px';
  }

  // ---- POPUPS ----
  function openAddPopup(){
    editIndex = -1;
    p_artnr.value = "";
    p_name.value = "";
    p_menge.value = 1;
    p_groesse.value = "";
    p_preis.value = "";
    p_ort.value = "";
    p_datum.value = "";
    p_bild.value = "";
    p_notiz.value = "";
    popup.style.display = 'block';
  }

  function openEditPopup(index){
    editIndex = index;
    const a = artikel[index];
    p_artnr.value = a.artnr || "";
    p_name.value = a.name || "";
    p_menge.value = a.menge || 0;
    p_groesse.value = a.groesse || "";
    p_preis.value = a.preis || "";
    p_ort.value = a.ort || "";
    p_datum.value = a.datum || "";
    p_notiz.value = a.notiz || "";
    p_bild.value = "";
    popup.style.display = 'block';
  }

  function closeArticlePopup(){
    popup.style.display = 'none';
    editIndex = -1;
  }

  function openViewPopup(html){
    viewPopup.innerHTML = html;
    viewPopup.style.display = 'block';
  }

  function closeViewPopup(){
    viewPopup.style.display = 'none';
    viewPopup.innerHTML = '';
  }

  // ---- SPEICHERN ----
  function onSave(){
    const baseData = {
      artnr: (p_artnr.value || "").trim(),
      name: (p_name.value || "").trim(),
      menge: Number(p_menge.value) || 0,
      groesse: (p_groesse.value || "").trim(),
      preis: Number(p_preis.value) || 0,
      ort: (p_ort.value || "").trim(),
      datum: p_datum.value || "",
      notiz: (p_notiz.value || "").trim()
    };

    if (!baseData.artnr || !baseData.name){
      alert("Artikelnummer und Name sind Pflicht.");
      return;
    }

    function finalize(b64){
      const existingMark = editIndex > -1 ? !!artikel[editIndex].markiert : false;
      const obj = {
        ...baseData,
        bild: b64 || (editIndex > -1 ? (artikel[editIndex].bild || "") : ""),
        markiert: existingMark
      };

      if (editIndex > -1){
        artikel[editIndex] = obj;
      } else {
        artikel.push(obj);
      }
      persist();
      closeArticlePopup();
      renderTable();
      updateCounters();
    }

    const file = p_bild.files && p_bild.files[0];
    if (file){
      const reader = new FileReader();
      reader.onload = e => finalize(e.target.result);
      reader.onerror = () => finalize("");
      reader.readAsDataURL(file);
    } else {
      finalize("");
    }
  }

  // ---- L√ñSCHEN ----
  function onDelete(index){
    if (!confirm("Artikel wirklich l√∂schen?")) return;
    artikel.splice(index, 1);
    persist();
    renderTable();
    updateCounters();
  }

  // ---- MARKIEREN ----
  function toggleMark(index){
    artikel[index].markiert = !artikel[index].markiert;
    persist();
    renderTable();
  }

  // ---- BILD / NOTIZ ANZEIGEN ----
  function onViewImage(index){
    const a = artikel[index];
    if (!a.bild){
      openViewPopup(`<div>Kein Bild hinterlegt.</div><br><button onclick="closeViewPopup()">Schlie√üen</button>`);
      return;
    }
    const html = `<img class="preview" src="${a.bild}"><br><button onclick="closeViewPopup()">Schlie√üen</button>`;
    openViewPopup(html);
  }

  function onViewNote(index){
    const a = artikel[index];
    const text = a.notiz ? a.notiz : "Keine Notiz hinterlegt.";
    const html = `<div style="white-space:pre-wrap;">${text}</div><br><button onclick="closeViewPopup()">Schlie√üen</button>`;
    openViewPopup(html);
  }

  // ---- RENDER ----
  function renderTable(){
    tableBody.innerHTML = "";
    artikel.forEach((a, i)=>{
      const tr = document.createElement('tr');
      if (a.markiert) tr.classList.add('marked');
      tr.innerHTML = `
        <td onclick="__toggleMark(${i})">${a.markiert ? "‚≠ê" : "‚òÜ"}</td>
        <td>${a.artnr || ""}</td>
        <td>${a.name || ""}</td>
        <td>${a.menge ?? ""}</td>
        <td>${a.groesse || ""}</td>
        <td>${(a.preis || 0).toFixed(2)}</td>
        <td>${a.ort || ""}</td>
        <td>${formatDatum(a.datum || "")}</td>
        <td class="iconCell">
          <span onclick="__viewImage(${i})">üì∑</span>
          <span onclick="__viewNote(${i})">üìù</span>
          <span onclick="__editArtikel(${i})">‚úèÔ∏è</span>
          <span class="delete" onclick="__deleteArtikel(${i})">üóë</span>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  // ---- COUNTER ----
  function updateCounters(){
    countArtikel.textContent = artikel.length;
    let menge = 0, wert = 0;
    artikel.forEach(a=>{
      const m = Number(a.menge) || 0;
      const p = Number(a.preis) || 0;
      menge += m;
      wert += m * p;
    });
    countMenge.textContent = menge;
    countWert.textContent = wert.toFixed(2);
    countWertTotal.textContent = wert.toFixed(2);
  }

  // ---- SUCHE ----
  function onSearch(){
    const q = (searchInput.value || "").toLowerCase();
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach((row, idx)=>{
      const a = artikel[idx];
      const hay = [
        a.artnr,a.name,a.groesse,a.ort,a.notiz,formatDatum(a.datum)
      ].join(" ").toLowerCase();
      row.style.display = hay.includes(q) ? "" : "none";
    });
  }

  // ---- EXPORT / IMPORT / PDF ----
  function onExport(){
    const blob = new Blob([JSON.stringify(artikel)], {type:"application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "lager.json";
    a.click();
  }

  function onImport(){
    const inp = document.createElement('input');
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = e=>{
      const file = e.target.files[0];
      if (!file) return;
      const r = new FileReader();
      r.onload = ev=>{
        try{
          const data = JSON.parse(ev.target.result);
          if (Array.isArray(data)){
            artikel = data;
            persist();
            renderTable();
            updateCounters();
          } else {
            alert("Ung√ºltige Datei.");
          }
        }catch(err){
          alert("Fehler beim Laden der Datei.");
        }
      };
      r.readAsText(file);
    };
    inp.click();
  }

  function onPDF(){
    alert("PDF kommt als n√§chster Schritt.");
  }

  // ---- GLOBALE BR√úCKEN F√úR onclick im HTML ----
  window.__toggleMark = toggleMark;
  window.__viewImage = onViewImage;
  window.__viewNote = onViewNote;
  window.__editArtikel = openEditPopup;
  window.__deleteArtikel = onDelete;
  window.closeViewPopup = closeViewPopup;

  // ---- EVENTS ----
  btnAdd.addEventListener('click', openAddPopup);
  btnSave.addEventListener('click', onSave);
  btnCancel.addEventListener('click', closeArticlePopup);
  btnExport.addEventListener('click', onExport);
  btnImport.addEventListener('click', onImport);
  btnPDF.addEventListener('click', onPDF);
  searchInput.addEventListener('input', onSearch);

  window.addEventListener('resize', adjustTableTop);

  // ---- INIT ----
  adjustTableTop();
  renderTable();
  updateCounters();
})();
</script>

</body>
</html>
