<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no">
<title>Lager App</title>

<style>
body{margin:0;background:#000;color:white;font-family:Arial,sans-serif;overflow:hidden;}
#topbar{position:fixed;top:0;left:0;right:0;padding:15px;background:#000;z-index:5000;border-bottom:2px solid #333;}
#counterWrapper{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
.counter-box{padding:10px;border:1px solid #444;border-radius:10px;background:#000;}
.counter-title{font-size:11px;color:#bbb;}
.counter-value{font-size:18px;font-weight:bold;}
#searchRow{margin-top:10px;}
#search{width:100%;padding:10px;border-radius:8px;background:#111;border:1px solid #444;color:white;box-sizing:border-box;}
#buttonRow{margin-top:10px;display:flex;gap:8px;}
#buttonRow button{flex:1;padding:10px;font-size:11px;color:#bbb;border-radius:10px;background:#000;border:1px solid #444;font-weight:bold;}

#tableContainer{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  overflow-y:auto;
  overflow-x:auto;
  background:#000;
  z-index:100;
}

table{width:100%;border-collapse:collapse;}
th{background:#111;position:sticky;top:0;z-index:200;padding:6px;color:#bbb;font-size:10px;white-space:nowrap;}
td{padding:5px;font-size:11px;border-bottom:1px solid #222;white-space:nowrap;}
.marked{background:#222;}
.iconCell span{cursor:pointer;margin-right:8px;}
.iconCell span.delete{margin-left:18px;}
input.miniQty{width:42px;background:#111;color:white;border:1px solid #444;border-radius:5px;text-align:center;}

#popup,#viewPopup{
position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
background:#111;padding:16px;border:2px solid #444;border-radius:12px;
width:90%;max-width:360px;max-height:90vh;overflow-y:auto;display:none;z-index:9999;
}
.popup-row{margin-bottom:8px;}
.popup-row label{font-size:12px;color:#bbb;display:block;margin-bottom:3px;}
.popup-row input,.popup-row textarea{
width:100%;padding:8px;border-radius:8px;
border:1px solid #444;background:#1a1a1a;color:white;
}
#popupButtons{display:flex;gap:8px;margin-top:10px;}
#popupButtons button{
flex:1;padding:11px;border-radius:10px;
background:#000;border:1px solid #444;color:white;font-weight:bold;
}
img.preview{max-width:100%;border-radius:8px;margin-top:10px;}
</style>
</head>

<body>

<div id="topbar">
  <div id="counterWrapper">
    <div class="counter-box"><div class="counter-title">Artikel im Bestand</div><div id="countArtikel">0</div></div>
    <div class="counter-box"><div class="counter-title">Gegenst√§nde insgesamt</div><div id="countMenge">0</div></div>
    <div class="counter-box"><div class="counter-title">Warenwert aktuell (‚Ç¨)</div><div id="countWert">0</div></div>
    <div class="counter-box"><div class="counter-title">Warenwert gesamt (‚Ç¨)</div><div id="countWertTotal">0</div></div>
  </div>

  <div id="searchRow"><input id="search" placeholder="Suchen ‚Ä¶"></div>

  <div id="buttonRow">
    <button id="btnAdd">Artikel anlegen</button>
    <button id="btnExport">Sichern</button>
    <button id="btnImport">Laden</button>
    <button id="btnPDF">PDF</button>
  </div>
</div>

<div id="tableContainer">
<table>
<thead>
<tr>
<th>*</th><th>Nr</th><th>Name</th><th>Menge</th>
<th>Gr√∂√üe</th><th>Einz.</th><th>Gesamt</th>
<th>Ort</th><th>Datum</th><th>Aktionen</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<div id="popup">
  <div class="popup-row"><label>Artikelnummer</label><input id="p_artnr"></div>
  <div class="popup-row"><label>Name</label><input id="p_name"></div>
  <div class="popup-row"><label>Menge</label><input type="number" id="p_menge" value="1"></div>
  <div class="popup-row"><label>Gr√∂√üe</label><input id="p_groesse"></div>
  <div class="popup-row"><label>Preis</label><input type="number" id="p_preis"></div>
  <div class="popup-row"><label>Ort</label><input id="p_ort"></div>
  <div class="popup-row"><label>Datum</label><input type="date" id="p_datum"></div>
  <div class="popup-row"><label>Bild</label><input type="file" id="p_bild"></div>
  <div class="popup-row"><label>Notiz</label><textarea id="p_notiz"></textarea></div>
  <div id="popupButtons">
    <button id="btnSave">Speichern</button>
    <button id="btnCancel">Abbrechen</button>
  </div>
</div>

<div id="viewPopup"></div>

<script>
let artikel = JSON.parse(localStorage.getItem("lagerData") || "[]");
let editIndex = -1;

/* ===== Artikelnummern-Logik ===== */

function initArtNrCounter(){
  const jahr = new Date().getFullYear();
  const key  = "artnrCounter_" + jahr;

  if (localStorage.getItem(key) !== null) return;

  let max = -1;
  artikel.forEach(a=>{
    if(!a.artnr) return;
    const m = a.artnr.match(/^(\d{3})-(\d{4})$/);
    if(m && Number(m[2]) === jahr){
      max = Math.max(max, Number(m[1]));
    }
  });

  localStorage.setItem(key, max);
}

function previewNextArtNr(){
  const jahr = new Date().getFullYear();
  const key  = "artnrCounter_" + jahr;
  const val  = Number(localStorage.getItem(key) || -1) + 1;
  return String(val).padStart(3,"0") + "-" + jahr;
}

function commitNextArtNr(){
  const jahr = new Date().getFullYear();
  const key  = "artnrCounter_" + jahr;
  let counter = Number(localStorage.getItem(key) || -1) + 1;
  localStorage.setItem(key, counter);
  return String(counter).padStart(3,"0") + "-" + jahr;
}

initArtNrCounter();

/* ===== Layout: Tabelle direkt unter Header ===== */

function adjustTableTop(){
  const header = document.getElementById("topbar");
  const tableC = document.getElementById("tableContainer");
  tableC.style.top = header.offsetHeight + "px";
}
window.addEventListener("load", adjustTableTop);
window.addEventListener("resize", adjustTableTop);

/* ===== Datum formatieren (TT-MM-JJJJ) ===== */

function formatDate(d){
  if(!d) return "";
  const [y,m,dd] = d.split("-");
  return `${dd}-${m}-${y}`;
}

/* ===== Rendern ===== */

function renderTable(){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  artikel.forEach((a,i)=>{
    const tr = document.createElement("tr");
    if(a.markiert) tr.classList.add("marked");
    const gesamt = (a.preis * a.menge).toFixed(2);

    tr.innerHTML = `
      <td onclick="toggleMark(${i})">${a.markiert ? "‚≠ê" : "‚òÜ"}</td>
      <td>${a.artnr || ""}</td>
      <td>${a.name || ""}</td>
      <td><input class="miniQty" type="number" value="${a.menge}" oninput="updateQty(${i},this.value)"></td>
      <td>${a.groesse || ""}</td>
      <td>${isNaN(a.preis) ? "" : a.preis.toFixed(2)}</td>
      <td>${isNaN(a.preis) ? "" : gesamt}</td>
      <td>${a.ort || ""}</td>
      <td>${a.datum ? formatDate(a.datum) : ""}</td>
      <td class="iconCell">
        <span onclick="viewImg(${i})">üì∑</span>
        <span onclick="viewNote(${i})">üìù</span>
        <span onclick="editArtikel(${i})">‚úèÔ∏è</span>
        <span class="delete" onclick="del(${i})">üóë</span>
      </td>
    `;
    tbody.appendChild(tr);
  });

  updateCounters();
  adjustTableTop();
}

/* ===== Z√§hler ===== */

function updateCounters(){
  let m = 0;
  let w = 0;
  artikel.forEach(a=>{
    m += a.menge || 0;
    w += (a.menge || 0) * (a.preis || 0);
  });
  document.getElementById("countArtikel").textContent   = artikel.length;
  document.getElementById("countMenge").textContent     = m;
  document.getElementById("countWert").textContent      = w.toFixed(2);
  document.getElementById("countWertTotal").textContent = w.toFixed(2);
}

/* ===== Menge direkt in Tabelle ===== */

function updateQty(i,val){
  artikel[i].menge = parseInt(val) || 0;
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  renderTable();
}

/* ===== Markieren (‚≠ê) ===== */

function toggleMark(i){
  artikel[i].markiert = !artikel[i].markiert;
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  renderTable();
}

/* ===== Pop-up Logik (Neu + Bearbeiten) ===== */

const btnAdd    = document.getElementById("btnAdd");
const btnSave   = document.getElementById("btnSave");
const btnCancel = document.getElementById("btnCancel");
const popup     = document.getElementById("popup");

btnAdd.onclick = () => {
  editIndex = -1;
  p_artnr.value           = previewNextArtNr(); // nur Vorschau
  p_name.value            = "";
  p_menge.value           = 1;
  p_groesse.value         = "";
  p_preis.value           = "";
  p_ort.value             = "";
  p_datum.value           = "";
  p_bild.value            = "";
  p_notiz.value           = "";
  popup.style.display     = "block";
};

btnCancel.onclick = () => {
  popup.style.display = "none";
  editIndex = -1;
};

btnSave.onclick = () => {
  if (editIndex === -1){
    // neuer Artikel => Artikelnummer wirklich verbrauchen
    const nextNr     = commitNextArtNr();
    const artnrInput = p_artnr.value.trim();
    const artnrFinal = artnrInput || nextNr;

    const obj = {
      artnr:  artnrFinal,
      name:   p_name.value.trim(),
      menge: +p_menge.value || 0,
      groesse:p_groesse.value.trim(),
      preis: +p_preis.value || 0,
      ort:    p_ort.value.trim(),
      datum:  p_datum.value,
      notiz:  p_notiz.value.trim(),
      bild:   "",
      markiert:false
    };

    const file = p_bild.files[0];
    if(file){
      const r = new FileReader();
      r.onload = e => { obj.bild = e.target.result; pushNew(obj); };
      r.readAsDataURL(file);
    } else {
      pushNew(obj);
    }

  } else {
    // Bearbeiten: bestehender Artikel
    const alt = artikel[editIndex];
    const artnrInput = p_artnr.value.trim();
    const obj = {
      artnr:  artnrInput || alt.artnr,
      name:   p_name.value.trim(),
      menge: +p_menge.value || 0,
      groesse:p_groesse.value.trim(),
      preis: +p_preis.value || 0,
      ort:    p_ort.value.trim(),
      datum:  p_datum.value,
      notiz:  p_notiz.value.trim(),
      bild:   alt.bild || "",
      markiert: alt.markiert || false
    };

    const file = p_bild.files[0];
    if(file){
      const r = new FileReader();
      r.onload = e => { obj.bild = e.target.result; applyEdit(obj); };
      r.readAsDataURL(file);
    } else {
      applyEdit(obj);
    }
  }
};

function pushNew(obj){
  artikel.push(obj);
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  popup.style.display = "none";
  editIndex = -1;
  renderTable();
}

function applyEdit(obj){
  artikel[editIndex] = obj;
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  popup.style.display = "none";
  editIndex = -1;
  renderTable();
}

/* ===== Bearbeiten-Icon ===== */

function editArtikel(i){
  editIndex           = i;
  const a             = artikel[i];
  p_artnr.value       = a.artnr || "";
  p_name.value        = a.name || "";
  p_menge.value       = a.menge || 1;
  p_groesse.value     = a.groesse || "";
  p_preis.value       = a.preis || 0;
  p_ort.value         = a.ort || "";
  p_datum.value       = a.datum || "";
  p_bild.value        = "";
  p_notiz.value       = a.notiz || "";
  popup.style.display = "block";
}

/* ===== L√∂schen, Bild, Notiz ===== */

const viewPopup = document.getElementById("viewPopup");

function del(i){
  if(confirm("Wirklich l√∂schen?")){
    artikel.splice(i,1);
    localStorage.setItem("lagerData", JSON.stringify(artikel));
    renderTable();
  }
}

function viewImg(i){
  const a = artikel[i];
  viewPopup.innerHTML = a.bild
    ? `<img class="preview" src="${a.bild}"><br><button onclick="viewPopup.style.display='none'">Schlie√üen</button>`
    : `<div>Kein Bild</div><br><button onclick="viewPopup.style.display='none'">Schlie√üen</button>`;
  viewPopup.style.display = "block";
}

function viewNote(i){
  const a = artikel[i];
  viewPopup.innerHTML = `<div>${a.notiz || "Keine Notiz"}</div>
  <br><button onclick="viewPopup.style.display='none'">Schlie√üen</button>`;
  viewPopup.style.display = "block";
}

/* ===== Sichern / Laden / PDF / Suche ===== */

const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const btnPDF    = document.getElementById("btnPDF");
const searchInp = document.getElementById("search");

btnExport.onclick = () => {
  const blob = new Blob([JSON.stringify(artikel)], {type:"application/json"});
  const a    = document.createElement("a");
  a.href     = URL.createObjectURL(blob);
  a.download = "lager_sicherung.json";
  a.click();
};

btnImport.onclick = () => {
  const inp = document.createElement("input");
  inp.type  = "file";
  inp.accept= "application/json";
  inp.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = () => {
      artikel = JSON.parse(r.result);
      localStorage.setItem("lagerData", JSON.stringify(artikel));
      initArtNrCounter();
      renderTable();
    };
    r.readAsText(file);
  };
  inp.click();
};

btnPDF.onclick = () => {
  let w = window.open("","_blank");
  let html = `<table border="1" cellpadding="4">
  <tr><th>Nr</th><th>Name</th><th>Menge</th><th>Notiz</th></tr>`;
  artikel.forEach(a=>{
    html += `<tr><td>${a.artnr||""}</td><td>${a.name||""}</td><td>${a.menge||0}</td><td></td></tr>`;
  });
  html += `</table>`;
  w.document.write(html);
  w.print();
};

searchInp.oninput = () => {
  const q = searchInp.value.toLowerCase();
  document.querySelectorAll("#tableBody tr").forEach(r=>{
    r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
  });
};

/* ===== Start ===== */
renderTable();
</script>

</body>
</html>
